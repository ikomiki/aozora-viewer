# 青空文庫ビューワ 要件定義書

## 概要

青空文庫形式のテキストファイルを、ブラウザ上で美しく読みやすい形式で表示するWebアプリケーション。ドラッグ＆ドロップによる直感的なファイル読み込みと、カスタマイズ可能な読書環境を提供する。

## ユーザストーリー

### ストーリー1: 青空文庫テキストの閲覧

- **である** 日本文学愛好者 **として**
- **私は** 青空文庫形式のテキストファイルをブラウザで美しく読みたい **をしたい**
- **そうすることで** 快適な読書体験を得られる

### ストーリー2: 直感的なファイル読み込み

- **である** ユーザー **として**
- **私は** テキストファイルをブラウザにドロップするだけで読み込みたい **をしたい**
- **そうすることで** 複雑な操作なしに素早くファイルを開ける

### ストーリー3: 読書環境のカスタマイズ

- **である** 読者 **として**
- **私は** 文字サイズや行間、テーマを自由に調整したい **をしたい**
- **そうすることで** 自分に最適な読書環境を構築できる

### ストーリー4: 目次による文書ナビゲーション

- **である** 読者 **として**
- **私は** 長い文書の目次から任意の章に素早く移動したい **をしたい**
- **そうすることで** 効率的に文書を読み進められる

## 機能要件（EARS記法）

### 通常要件

- REQ-001: システムは青空文庫形式のテキストファイルを解析し、ルビ記法（文字列《ふりがな》）を正しく表示しなければならない
- REQ-002: システムは見出し記法（［＃「見出し文字列」は大/中/小見出し］）を認識し、適切な階層構造で表示しなければならない
- REQ-003: システムは画像記法（［＃画像説明（ファイル名、サイズ）入る］）を解析し、画像を表示しなければならない
- REQ-004: システムはキャプション記法（［＃「画像説明文」はキャプション］）を認識し、画像下部にキャプションを表示しなければならない
- REQ-005: システムはテキストファイル行頭の全角空白文字を、削除せずにそのまま表示しなければならない
- REQ-006: システムは［＃地から２字上げ］のような指示のある場合、行頭に全角空白文字を指定個数分だけ挿入しなければならない
- REQ-007: システムは［＃ここから１字下げ］のような指示で始まり［＃ここで字下げ終わり］で終わるブロックについて、それぞれの行頭に全角空白文字を指定個数分だけ挿入しなければならない
- REQ-008: システムは字下げ指示行そのものを改行も残さず除去しなければならない
- REQ-009: システムはブラウザページ全体でテキストファイルのドロップを受け付けなければならない
- REQ-010: システムは左サイドバーに目次ツリーを表示しなければならない
- REQ-011: システムは右サイドバーに表示設定パネルを表示しなければならない
- REQ-012: システムは表示設定をlocalStorageに保存しなければならない

### 条件付き要件

- REQ-101: テキストファイルがドロップされた場合、システムは即座にファイルを読み込み、内容を表示しなければならない
- REQ-102: ルビ範囲が不明確な場合（｜記号使用）、システムは｜から《》までをルビとして処理しなければならない
- REQ-103: 見出しが検出された場合、システムは目次ツリーに該当項目を追加しなければならない
- REQ-104: 目次項目がクリックされた場合、システムは該当する見出し位置にスクロールしなければならない
- REQ-105: サイドバーの開閉ボタンがクリックされた場合、システムはサイドバーの表示状態を切り替えなければならない
- REQ-106: テーマ設定でOSシステム設定が選択された場合、システムはブラウザのprefers-color-schemeに従ってテーマを適用しなければならない
- REQ-107: 字上げ指示（［＃地から○字上げ］）が検出された場合、システムは該当行の先頭に指定個数分の全角空白を挿入しなければならない
- REQ-108: 字下げブロック（［＃ここから○字下げ］〜［＃ここで字下げ終わり］）が検出された場合、システムはブロック内の全行頭に指定個数分の全角空白を挿入しなければならない
- REQ-109: 字下げ指示行が検出された場合、システムは該当する指示行を表示から完全に除去しなければならない

### 状態要件

- REQ-201: ファイルが読み込まれていない状態では、システムはファイルドロップ促進メッセージを表示しなければならない
- REQ-202: サイドバーが閉じられている状態では、システムは開くためのトグルボタンのみを表示しなければならない
- REQ-203: 画像ファイルが存在しない状態では、システムは代替テキストまたはプレースホルダーを表示しなければならない

### オプション要件

- REQ-301: システムは傍点や傍線などの強調記法を表示してもよい
- REQ-302: システムは縦中横記法を適用してもよい
- REQ-303: システムは文字の修正記法を表示してもよい

### 制約要件

- REQ-401: システムはブラウザ上で動作しなければならない
- REQ-402: システムはファイルアップロードサーバーを必要としてはならない
- REQ-403: システムは個人情報を外部に送信してはならない

## 非機能要件

### パフォーマンス

- NFR-001: ファイル読み込み後、3秒以内に初期表示を完了しなければならない
- NFR-002: 設定変更後、1秒以内に表示に反映されなければならない
- NFR-003: 10MB以下のテキストファイルを問題なく処理できなければならない

### ユーザビリティ

- NFR-101: ドラッグ＆ドロップ操作に明確な視覚的フィードバックを提供しなければならない
- NFR-102: キーボード操作のみでも主要機能を利用できなければならない
- NFR-103: モバイルデバイスでも基本的な閲覧機能を提供しなければならない

### 表示設定

- NFR-201: 左右マージンは10px〜200pxの範囲で調整可能でなければならない
- NFR-202: 文字サイズは12px〜36pxの範囲で調整可能でなければならない
- NFR-203: 文字間は-2px〜10pxの範囲で調整可能でなければならない
- NFR-204: 行間は1.0〜3.0の範囲で調整可能でなければならない
- NFR-205: ライト、ダーク、OSシステム設定の3つのテーマを提供しなければならない

### 互換性

- NFR-301: Chrome、Firefox、Safari、Edgeの最新版で動作しなければならない
- NFR-302: 標準的な青空文庫記法との完全な互換性を保たなければならない

## Edgeケース

### エラー処理

- EDGE-001: 不正な形式のファイルがドロップされた場合、適切なエラーメッセージを表示する
- EDGE-002: 画像ファイルの読み込みに失敗した場合、代替表示を行う
- EDGE-003: localStorageが使用できない場合、デフォルト設定で動作する
- EDGE-004: 破損したテキストファイルの場合、読み込み可能な部分のみを表示する

### 境界値

- EDGE-101: 空のテキストファイルがドロップされた場合の処理
- EDGE-102: 非常に長い見出し（100文字以上）の場合の表示処理
- EDGE-103: ルビが非常に長い場合（漢字より長い）の表示調整
- EDGE-104: 最大サイズ（10MB）のファイル処理時のメモリ管理
- EDGE-105: 字下げ指示で異常に大きな数値（100字など）が指定された場合の処理
- EDGE-106: 字下げブロックの終了指示（［＃ここで字下げ終わり］）が存在しない場合の処理
- EDGE-107: 字下げブロックがネストしている場合の処理

### UI/UX境界

- EDGE-201: 非常に多数の見出しがある場合（100個以上）の目次表示
- EDGE-202: 小さな画面サイズでのサイドバー表示
- EDGE-203: サイドバー両方が開いている状態での本文表示領域の最小幅確保

## 受け入れ基準

### 機能テスト

- [ ] ルビ記法の正常な解析と表示
- [ ] 大・中・小見出しの階層的表示
- [ ] 画像とキャプションの適切な表示
- [ ] 行頭全角空白文字の保持表示
- [ ] 字上げ指示（［＃地から○字上げ］）の正常な処理
- [ ] 字下げブロック（［＃ここから○字下げ］〜［＃ここで字下げ終わり］）の正常な処理
- [ ] 字下げ指示行の完全除去
- [ ] ファイルドロップ機能の動作確認
- [ ] 目次ツリーの生成と動作確認
- [ ] 左右サイドバーの開閉機能
- [ ] 全表示設定項目の動作確認
- [ ] 3つのテーマの切り替え確認
- [ ] localStorage保存・復元機能

### 非機能テスト

- [ ] 10MBファイルの処理性能確認
- [ ] 設定変更時の応答性確認
- [ ] 主要ブラウザでの動作確認
- [ ] モバイルデバイスでの表示確認
- [ ] キーボード操作のアクセシビリティ確認
- [ ] ドラッグ＆ドロップの視覚的フィードバック確認

### エラーハンドリングテスト

- [ ] 不正ファイル形式の適切な処理
- [ ] 画像読み込みエラー時の代替表示
- [ ] localStorage無効時のフォールバック動作
- [ ] ネットワーク切断時の画像表示処理